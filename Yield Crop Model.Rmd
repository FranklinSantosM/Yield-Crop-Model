---
title: "Yiel Crop Model"
author: "Franklin Santos"
date: "9/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Antecedentes

칔ltimamente he publicado screencasts que demuestran c칩mo utilizar el marco tidymodels, desde el comienzo hasta el ajuste de modelos m치s complejos. El screencast de hoy explora c칩mo aplicar con fluidez los principios de datos ordenados a la tarea de construir muchos modelos usando el conjunto de datos #TidyTuesday de esta semana sobre el rendimiento de los cultivos. 游꺟

Este publicaci칩n tiene un tutorial en YouTube por Jualia Silge "https://www.youtube.com/watch?v=rhhuNGjj3cU"

Aqu칤 est치 el c칩digo que utilic칠 en el video, para aquellos que prefieren leer en lugar o adem치s del video.

## Exploraci칩n de datos

Nuestro objetivo de modelado es estimar c칩mo est치n cambiando los [rendimientos de los cultivos en todo el mundo utilizando el conjunto de datos #TidyTuesday <https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-09-01/readme.md>] de esta semana. Podemos construir muchos modelos para las combinaciones pa칤s-cultivo que nos interesan.

Primero, leamos dos de los conjuntos de datos de esta semana.

```{r}
library(tidyverse)

key_crop_yields <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/key_crop_yields.csv")
land_use <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-01/land_use_vs_yield_change_in_cereal_production.csv")
```

Usar칠 el conjunto de datos land_use solo para encontrar los pa칤ses con mayor poblaci칩n. Creemos un vector de sus nombres.

```{r}
top_countries <- land_use %>%
  janitor::clean_names() %>%
  filter(!is.na(code), entity != "World") %>%
  group_by(entity) %>%
  filter(year == max(year)) %>%
  ungroup() %>%
  slice_max(total_population_gapminder, n = 30) %>%
  pull(entity)

top_countries
```

Ahora creemos una versi칩n ordenada de los datos de rendimiento de los cultivos, para los pa칤ses y cultivos que me interesan.

```{r}
tidy_yields <- key_crop_yields %>%
  janitor::clean_names() %>%
  pivot_longer(wheat_tonnes_per_hectare:bananas_tonnes_per_hectare,
    names_to = "crop", values_to = "yield"
  ) %>%
  mutate(crop = str_remove(crop, "_tonnes_per_hectare")) %>%
  filter(
    crop %in% c("wheat", "rice", "maize", "barley"),
    entity %in% top_countries,
    !is.na(yield)
  )

tidy_yields
```

춰Esta estructura de datos es perfecta para graficar el **rendimiento del cultivo a lo largo del tiempo!**

```{r}
tidy_yields %>%
  ggplot(aes(year, yield, color = crop)) +
  geom_line(alpha = 0.7, size = 1.5) +
  geom_point() +
  facet_wrap(~entity, ncol = 5) +
  scale_x_continuous(guide = guide_axis(angle = 90)) +
  labs(x = NULL, y = "yield (tons per hectare)")
```

Tenga en cuenta que no todos los pa칤ses producen todos los cultivos, pero que el rendimiento general de los cultivos est치 *aumentando*.

## Muchos modelos

Ahora ajustemos un modelo lineal a cada combinaci칩n de cultivo y pa칤s.

```{r}
library(tidymodels)

tidy_lm <- tidy_yields %>%
  nest(yields = c(year, yield)) %>%
  mutate(model = map(yields, ~ lm(yield ~ year, data = .x)))

tidy_lm
```

A continuaci칩n, vamos a ordenar con tidy() esos modelos para obtener los coeficientes y ajustar los valores p para m칰ltiples comparaciones mientras estamos en ello.

```{r}
slopes <- tidy_lm %>%
  mutate(coefs = map(model, tidy)) %>%
  unnest(coefs) %>%
  filter(term == "year") %>%
  mutate(p.value = p.adjust(p.value))

slopes
```

## Explorar resultados

Ahora podemos visualizar los resultados de este modelo, que est치 estimando c칩mo est치n cambiando los rendimientos de los cultivos en todo el mundo.

```{r}
#library(ggrepel)
#slopes %>%
 # ggplot(aes(estimate, p.value, label = entity)) +
  #geom_vline(
   # xintercept = 0, lty = 2,
    #size = 1.5, alpha = 0.7, color = "gray50"
  #) +
  #geom_point(aes(color = crop), alpha = 0.8, size = 2.5, show.legend = FALSE) +
  #scale_y_log10() +
  #facet_wrap(~crop) +
  #geom_text_repel(size = 3, family = "IBMPlexSans") +
  #theme_light(base_family = "IBMPlexSans") +
  #theme(strip.text = element_text(family = "IBMPlexSans-Bold", size = 12)) +
  #labs(x = "increase in tons per hectare per year")

# Modified model function
library(ggrepel)
slopes %>%
  ggplot(aes(estimate, p.value, label = entity)) +
  geom_vline(
    xintercept = 0, lty = 2,
    size = 1.5, alpha = 0.7, color = "gray50") +
  geom_point(aes(color = crop), alpha = 0.8, size = 2.5, show.legend = FALSE) +
  scale_y_log10() +
  facet_wrap(~crop) +
  geom_text_repel(size = 2.5) +
  theme_light() +
  theme(strip.text = element_text(size = 12)) +
  labs(x = "increase in tons per hectare per year")

  
```

* En el eje-x est치 la pendiente de estos modelos. Tenga en cuenta que la mayor칤a de los pa칤ses est치n en el lado positivo, con rendimientos de cultivos en aumento. Cuanto m치s a la derecha est칠 un pa칤s, mayor ser치 el aumento del rendimiento de los cultivos durante este per칤odo de tiempo. Los rendimientos de ma칤z son los que m치s han aumentado.

* En el eje-y est치 el valor p, una medida de cu치n sorprendente es el efecto que vemos bajo el supuesto de que no hay relaci칩n (sin cambios con el tiempo). Los pa칤ses m치s bajos en las parcelas tienen valores p m치s peque침os; estamos m치s seguros de que se trata de relaciones reales.

Podemos ampliar esto para comprobar qu칠 tan bien estos modelos se ajustan a los datos con glance(). 춰Este enfoque para usar modelos estad칤sticos para estimar cambios en muchos subgrupos a la vez me ha sido muy 칰til en muchas situaciones!










